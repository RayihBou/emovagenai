AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Emova - Analítica de Conversaciones (Arquitectura Asíncrona)

Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 256
    Tags:
      Project: EMOVA
  Api:
    Cors:
      AllowMethods: "'GET,POST,OPTIONS'"
      AllowHeaders: "'Content-Type'"
      AllowOrigin: "'*'"

Parameters:
  Environment:
    Type: String
    Default: dev
  AudioBucketName:
    Type: String
    Default: emova-audio-302263078976-dev

Resources:
  EmovaApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub emova-api-${Environment}
      StageName: !Ref Environment
      Tags:
        Project: EMOVA

  # Lambda: Iniciar job asíncrono
  StartJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub emova-start-job-${Environment}
      Handler: start_job_handler.handler
      CodeUri: src/
      Environment:
        Variables:
          AUDIO_BUCKET: !Ref AudioBucketName
          PROCESS_FUNCTION_NAME: !Ref ProcessJobFunction
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref AudioBucketName
        - LambdaInvokePolicy:
            FunctionName: !Ref ProcessJobFunction
      Events:
        StartJobApi:
          Type: Api
          Properties:
            RestApiId: !Ref EmovaApi
            Path: /analyze-session
            Method: post

  # Lambda: Procesar job en background
  ProcessJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub emova-process-job-${Environment}
      Handler: process_job_handler.handler
      CodeUri: src/
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          AUDIO_BUCKET: !Ref AudioBucketName
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref AudioBucketName
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: [transcribe:StartTranscriptionJob, transcribe:GetTranscriptionJob]
              Resource: '*'
            - Effect: Allow
              Action: bedrock:InvokeModel
              Resource: '*'

  # Lambda: Consultar estado del job
  JobStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub emova-job-status-${Environment}
      Handler: job_status_handler.handler
      CodeUri: src/
      Environment:
        Variables:
          AUDIO_BUCKET: !Ref AudioBucketName
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref AudioBucketName
      Events:
        JobStatusApi:
          Type: Api
          Properties:
            RestApiId: !Ref EmovaApi
            Path: /job/{job_id}
            Method: get

  # Lambda: Obtener URL presignada para upload
  UploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub emova-upload-url-${Environment}
      Handler: upload_handler.handler
      CodeUri: src/
      Environment:
        Variables:
          AUDIO_BUCKET: !Ref AudioBucketName
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref AudioBucketName
      Events:
        UploadApi:
          Type: Api
          Properties:
            RestApiId: !Ref EmovaApi
            Path: /upload-url
            Method: get

Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value: !Sub https://${EmovaApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
